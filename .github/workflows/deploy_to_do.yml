name: Deploy to DigitalOcean via Tailscale

# âœ… Manual-only trigger
on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  deploy:
    name: Manual Deploy Over Tailscale
    runs-on: ubuntu-24.04

    steps:
      # ğŸ“¥ Step 1: Set up Tailscale on the GitHub Actions runner
      - name: Setup Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:github-actions
          version: latest
          use-cache: 'true'

      # âœ… Step 2: SSH and deploy to the droplet over Tailscale IP
      - name: SSH and Deploy with Docker Compose
        run: |
          # Set up SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DO_TAILSCALE_NAME }} >> ~/.ssh/known_hosts
    
          # Execute SSH command
          ssh -o StrictHostKeyChecking=no ${{ secrets.DO_USERNAME }}@${{ secrets.DO_TAILSCALE_NAME }} '
            set -e

            echo "ğŸ“¦ Starting manual deployment to Tailscale-connected droplet..."
            cd /home/deploy

            echo "ğŸ“¥ Pulling latest stable image from GHCR..."
            echo ${{ secrets.GHCR_PAT }} | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
            docker pull ${{ secrets.BACKEND_IMAGE_NAME }}

            echo "ğŸ“Œ Capturing current rust-app container ID for rollback..."
            docker compose ps -q rust-app > old_container_id.txt || true
            OLD_CONTAINER_ID=$(cat old_container_id.txt || echo "")
            OLD_IMAGE=$(docker inspect --format='{{.Image}}' $OLD_CONTAINER_ID 2>/dev/null || echo "")

            echo "ğŸ›‘ Stopping existing containers..."
            docker compose down

            echo "ğŸš€ Starting new containers with updated image..."
            docker compose up -d

            echo "â³ Waiting for rust-app to initialize..."
            sleep 15

            echo "ğŸ©º Checking rust-app status..."
            docker ps | grep rust-app > /dev/null
            if [ $? -ne 0 ]; then
              echo "âŒ rust-app failed to start. Initiating rollback..."

              if [ ! -z "$OLD_IMAGE" ]; then
                echo "ğŸ” Rolling back to previous image: $OLD_IMAGE"
                docker compose down
                docker rmi ${{ secrets.BACKEND_IMAGE_NAME }} || true
                docker tag $OLD_IMAGE ${{ secrets.BACKEND_IMAGE_NAME }}

                echo "ğŸ”„ Restarting services with previous image..."
                docker compose up -d
                echo "âœ… Rollback complete."
              else
                echo "âš ï¸ No image available to roll back to. Manual intervention may be required."
              fi
            else
              echo "âœ… Deployment succeeded! rust-app is running."
            fi

            echo "ğŸ‰ Deployment completed."
